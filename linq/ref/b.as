global	_seek_err
global	ncsv, cret, indir
global	_fatal_err
global	_libraryName
psect	text
_seek_err:
ld	hl,(_libraryName)
push	hl
ld	hl,19f
push	hl
call	_fatal_err
pop	bc
pop	bc
ret	
global	_allocModuleArrays
global	_num_files
global	_libTable
global	_xalloc
_allocModuleArrays:
global csv
call csv
ld	l,(ix+6)
ld	h,(ix+7)
ld	(_num_files),hl
add	hl,hl
push	hl
call	_xalloc
ld	(_libTable),hl
jp	cret
global	_conv_letou32
global	shll
global	shll
global	shll
_conv_letou32:
global csv
call csv
ld	l,(ix+6)
ld	h,(ix+7)
push	hl
pop	iy
ld	b,24
ld	l,(iy+3)
ld	h,0
call	shll
ex	de,hl
push	de
ld	b,16
ld	l,(iy+2)
ld	h,0
call	shll
ex	de,hl
push	de
ld	b,8
ld	l,(iy+1)
ld	h,0
call	shll
ex	de,hl
ld	l,(iy+0)
ld	h,0
add	hl,de
pop	de
add	hl,de
pop	de
add	hl,de
ex	de,hl
ld	hl,0
jp	cret
global	_conv_btou16
global	shll
_conv_btou16:
global csv
call csv
ld	l,(ix+6)
ld	h,(ix+7)
push	hl
pop	iy
ld	b,8
ld	l,(iy+1)
ld	h,0
call	shll
ex	de,hl
ld	l,(iy+0)
ld	h,0
add	hl,de
jp	cret
global	_openLibrary
global	_fname_obj
global	_libraryFp
global	_fopen
global	_fread
global	_libBuf
global	_unexp_eof
global	_num_modules
global	_size_symbols
global	_libHandlers
global	_linker_pass
global	_fclose
_openLibrary:
ld	hl,(_fname_obj)
ld	(_libraryName),hl
ld	hl,0
ld	(_fname_obj),hl
ld	hl,29f
push	hl
ld	hl,(_libraryName)
push	hl
call	_fopen
pop	bc
pop	bc
ld	(_libraryFp),hl
ld	a,l
or	h
jp	nz,l10
ld	hl,(_libraryName)
push	hl
ld	hl,39f
push	hl
call	_fatal_err
pop	bc
pop	bc
l10:
ld	hl,(_libraryFp)
push	hl
ld	hl,4
push	hl
ld	hl,1
push	hl
ld	hl,_libBuf
push	hl
call	_fread
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,4
or	a
sbc	hl,de
call	nz,_unexp_eof
ld	hl,_libBuf+2
push	hl
call	_conv_btou16
ld	(_num_modules),hl
ld	hl,_libBuf
ex	(sp),hl
call	_conv_btou16
pop	bc
ld	(_size_symbols),hl
ld	de,_libHandlers
ld	a,(_linker_pass)
ld	l,a
ld	h,0
add	hl,hl
add	hl,de
ld	a,(hl)
inc	hl
ld	h,(hl)
ld	l,a
call	indir
ld	hl,0
ld	(_libraryName),hl
ld	hl,(_libraryFp)
push	hl
call	_fclose
pop	bc
ret	
global	_libPass1
global	_num_lib_files
global	adiv
global	_fseek
global	_moduleFp
global	_visitModules
global	_scanModule
_libPass1:
ld	de,(_num_modules)
ld	hl,15
add	hl,de
ld	de,16
call	adiv
add	hl,hl
push	hl
call	_xalloc
pop	bc
push	hl
ld	de,(_libTable)
ld	hl,(_num_lib_files)
add	hl,hl
add	hl,de
pop	de
ld	(hl),e
inc	hl
ld	(hl),d
ld	hl,0
push	hl
ld	de,4
push	hl
push	de
ld	hl,(_libraryFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
jp	z,L1
ld	hl,0
push	hl
ld	de,(_size_symbols)
ld	a,d
rla
sbc	a,a
ld	l,a
ld	h,a
ex	de,hl
ld	bc,4
add	hl,bc
ex	de,hl
ld	bc,0
adc	hl,bc
push	hl
push	de
ld	hl,(_moduleFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
jp	nz,l13
L1:
call	_seek_err
l13:
ld	hl,_scanModule
push	hl
call	_visitModules
pop	bc
ret	
global	_moduleNeeded
global	adiv
global	shal
global	_symSize
global	_visitSymbols
global	_chkModuleNeeded
global	shal
global	adiv
global	_moduleLoaded
global	_doObjFile
global	_moduleSize
_scanModule:
global csv
call csv
xor	a
ld	(_moduleNeeded),a
ld	de,(_libTable)
ld	hl,(_num_lib_files)
add	hl,hl
add	hl,de
ld	c,(hl)
inc	hl
ld	b,(hl)
push	bc
ld	de,16
ld	l,(ix+6)
ld	h,(ix+7)
call	adiv
add	hl,hl
pop	bc
add	hl,bc
ld	c,(hl)
inc	hl
ld	b,(hl)
push	bc
ld	a,(ix+6)
and	15
ld	b,a
ld	hl,1
call	shal
pop	bc
ld	a,l
and	c
ld	l,a
ld	a,h
and	b
ld	h,a
ld	a,l
or	h
jp	z,l15
ld	hl,1
push	hl
ld	de,(_symSize)
ld	a,d
rla
sbc	a,a
ld	l,a
ld	h,a
push	hl
push	de
ld	hl,(_libraryFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
jp	nz,l17
call	_seek_err
jp	l17
l15:
ld	hl,_chkModuleNeeded
push	hl
call	_visitSymbols
pop	bc
ld	a,(_moduleNeeded)
or	a
jp	z,l17
ld	a,(ix+6)
and	15
ld	b,a
ld	hl,1
call	shal
push	hl
ld	de,(_libTable)
ld	hl,(_num_lib_files)
add	hl,hl
add	hl,de
ld	c,(hl)
inc	hl
ld	b,(hl)
push	bc
ld	de,16
ld	l,(ix+6)
ld	h,(ix+7)
call	adiv
add	hl,hl
pop	bc
add	hl,bc
ld	c,(hl)
inc	hl
ld	b,(hl)
pop	de
ld	a,c
or	e
ld	c,a
ld	a,b
or	d
ld	b,a
ld	(hl),b
dec	hl
ld	(hl),c
ld	a,1
ld	(_moduleLoaded),a
call	_doObjFile
l17:
ld	a,(_moduleNeeded)
or	a
jp	nz,cret
ld	hl,1
push	hl
ld	de,(_moduleSize)
ld	hl,(_moduleSize+2)
push	hl
push	de
ld	hl,(_moduleFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
jp	nz,cret
call	_seek_err
jp	cret
global	_getSymbol
_chkModuleNeeded:
global csv
call csv
ld	a,(_moduleNeeded)
or	a
jp	nz,cret
ld	a,(ix+8)
or	a
jp	nz,cret
ld	hl,0
push	hl
ld	l,(ix+6)
ld	h,(ix+7)
push	hl
call	_getSymbol
pop	bc
pop	bc
push	hl
pop	iy
ld	a,l
or	h
jp	z,cret
ld	de,6
ld	a,(iy+8)
and	15
ld	l,a
xor	a
ld	h,a
or	a
sbc	hl,de
jp	nz,cret
ld	a,1
ld	(_moduleNeeded),a
jp	cret
global	_libPass2
global	_key_M
global	_printf
global	_doModule
_libPass2:
ld	a,(_key_M)
or	a
jp	z,l25
ld	hl,(_libraryName)
push	hl
ld	hl,49f
push	hl
call	_printf
pop	bc
pop	bc
l25:
ld	hl,1
push	hl
ld	de,(_size_symbols)
ld	a,d
rla
sbc	a,a
ld	l,a
ld	h,a
ex	de,hl
ld	bc,4
add	hl,bc
ex	de,hl
ld	bc,0
adc	hl,bc
push	hl
push	de
ld	hl,(_moduleFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
call	z,_seek_err
ld	hl,_doModule
push	hl
call	_visitModules
pop	bc
ret	
global	adiv
global	shal
_doModule:
global csv
call csv
ld	de,(_libTable)
ld	hl,(_num_lib_files)
add	hl,hl
add	hl,de
ld	c,(hl)
inc	hl
ld	b,(hl)
push	bc
ld	de,16
ld	l,(ix+6)
ld	h,(ix+7)
call	adiv
add	hl,hl
pop	bc
add	hl,bc
ld	c,(hl)
inc	hl
ld	b,(hl)
push	bc
ld	a,(ix+6)
and	15
ld	b,a
ld	hl,1
call	shal
pop	bc
ld	a,l
and	c
ld	l,a
ld	a,h
and	b
ld	h,a
ld	a,l
or	h
jp	z,l28
call	_doObjFile
jp	l29
l28:
ld	hl,1
push	hl
ld	de,(_moduleSize)
ld	hl,(_moduleSize+2)
push	hl
push	de
ld	hl,(_moduleFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
call	z,_seek_err
l29:
ld	hl,1
push	hl
ld	de,(_symSize)
ld	a,d
rla
sbc	a,a
ld	l,a
ld	h,a
push	hl
push	de
ld	hl,(_libraryFp)
push	hl
call	_fseek
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,-1
or	a
sbc	hl,de
jp	nz,cret
call	_seek_err
jp	cret
global	_symCnt
global	_readName
_visitModules:
global csv
call csv
push hl
ld	(ix+-2),0
ld	(ix+-1),0
jp	l36
l33:
ld	hl,(_libraryFp)
push	hl
ld	hl,1
push	hl
ld	hl,12
push	hl
ld	hl,_libBuf
push	hl
call	_fread
pop	bc
pop	bc
pop	bc
pop	bc
ld	de,1
or	a
sbc	hl,de
call	nz,_unexp_eof
ld	hl,_libBuf
push	hl
call	_conv_btou16
ld	(_symSize),hl
ld	hl,_libBuf+2
ex	(sp),hl
call	_conv_btou16
ld	(_symCnt),hl
ld	hl,_libBuf+4
ex	(sp),hl
call	_conv_letou32
ld	(_moduleSize),de
ld	(_moduleSize+2),hl
ld	hl,_libBuf+12
ld	(_fname_obj),hl
ex	(sp),hl
call	_readName
pop	bc
ld	l,(ix+-2)
ld	h,(ix+-1)
push	hl
ld	l,(ix+6)
ld	h,(ix+7)
call	indir
pop	bc
ld	hl,0
ld	(_fname_obj),hl
ld	l,(ix+-2)
ld	h,(ix+-1)
inc	hl
ld	(ix+-2),l
ld	(ix+-1),h
l36:
ld	de,(_num_modules)
ld	l,(ix+-2)
ld	h,(ix+-1)
or	a
sbc	hl,de
jp	nz,l33
jp	cret
psect	data
19:
defb	37,115,58,32,67,97,110,39,116,32,115,101,101,107,0
29:
defb	114,98,0
39:
defb	37,115,58,32,67,97,110,39,116,32,111,112,101,110,0
49:
defb	10,37,115,10,0
psect	text
me_obj),hl
ex	(sp),hl
call	_readName
pop	bc
ld	l,(ix+-2)
ld	h,(ix+-1)
push	hl
ld	l,(ix+6)
ld	h,(ix+7)
call	indi